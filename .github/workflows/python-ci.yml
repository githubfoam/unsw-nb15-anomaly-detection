name: Python CI

on:
  push:
    branches: [test]
  pull_request:
    branches: [test]
  # Enables manual trigger from the GitHub Actions UI
  workflow_dispatch:
  schedule:
    - cron:  '15 19 * * *' # Scheduled to run at 19:15 UTC every day   

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, '3.10', '3.11', '3.12'] # Using modern Python versions
        # python-version: ['3.12'] # Using modern Python versions
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Download UNSW-NB15 dataset from Kaggle
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      run: |
        # Install Kaggle API client
        pip install kaggle
        
        # Create .kaggle directory and configure with secrets
        mkdir -p ~/.kaggle
        echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > ~/.kaggle/kaggle.json
        chmod 600 ~/.kaggle/kaggle.json

        # Download the dataset
        # The dataset name is "kagglefoam/unsw-nb15" on Kaggle
        kaggle datasets download -d kagglefoam/unsw-nb15 -p data

         # Unzip the downloaded file directly into the data directory
        unzip data/unsw-nb15.zip -d data
        
        # Clean up the zip file and other unnecessary files
        rm -f data/unsw-nb15.zip data/NUSW-NB15GT.csv data/NUSW-NB15_features.csv
        
        echo "âœ… Dataset downloaded and prepared successfully."
    
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Install tools for running notebooks in the CI environment
        pip install nbformat ipykernel jupyter

    - name: Run notebook
      run: |
        # Execute the notebook to ensure all cells run without errors.
        # The `--execute` flag runs all cells.
        # The `--to notebook` and `--output` flags save the executed notebook
        # for inspection, if needed.
        jupyter nbconvert --to notebook --execute notebooks/unsw_nb15_anomaly_detection.ipynb --output test_unsw_nb15_anomaly_detection.ipynb
